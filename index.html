<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Faculty Laboratory eLog System - Good Samaritan Colleges</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --gsc-blue:#1e3a8a;
      --gsc-accent:#2563eb;
      --gsc-bg:#f1f5f9;
    }
    body { font-family:'Segoe UI',Arial,sans-serif;margin:0;background:var(--gsc-bg);color:#222; }
    header { background:white;color:var(--gsc-blue);padding:15px 20px;box-shadow:0 4px 10px rgba(0,0,0,0.08);border-bottom:4px solid var(--gsc-blue);}
    .header-container{display:flex;align-items:center;gap:18px;flex-wrap:wrap;max-width:1100px;margin:0 auto;}
    .gsc-logo{width:100px;height:auto;display:block;}
    .header-text h1{margin:0;font-size:22px;color:var(--gsc-blue);}
    .header-text p{margin:4px 0 0;font-size:14px;color:var(--gsc-accent);font-weight:500;}
    nav{max-width:1100px;margin:16px auto 0;padding:0 20px;display:flex;gap:10px;}
    .tab{background:white;padding:10px 16px;border-radius:8px;border:1px solid #e6eefc;cursor:pointer;font-weight:600;color:var(--gsc-blue);box-shadow:0 2px 6px rgba(0,0,0,0.04);}
    .tab.active{background:linear-gradient(90deg,var(--gsc-blue),var(--gsc-accent));color:white;border-color:transparent;}
    main{max-width:1100px;margin:18px auto;padding:0 20px 40px;}
    .card{background:white;border-radius:12px;padding:18px;box-shadow:0 6px 16px rgba(15,23,42,0.04);margin-bottom:18px;}
    form h2{margin:0 0 12px;text-align:center;color:var(--gsc-blue);}
    input,textarea,select,button{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ced4da;border-radius:6px;font-size:14px;}
    button.primary{background:var(--gsc-accent);color:white;border:none;cursor:pointer;font-weight:700;}
    button.secondary{background:#fff;border:1px solid #ddd;color:#333;cursor:pointer;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row .col{flex:1;min-width:150px;}
    .controls{display:flex;gap:10px;justify-content:flex-end;margin-bottom:12px;flex-wrap:wrap;}
    table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 6px 16px rgba(15,23,42,0.04);}
    th,td{padding:10px;border:1px solid #e6eefc;text-align:left;font-size:13px;}
    th{background:var(--gsc-blue);color:white;}
    tr:nth-child(even) td{background:#fbfdff;}
    .reports-grid{display:grid;grid-template-columns:1fr;gap:18px;}
    .report-card{display:flex;gap:14px;align-items:flex-start;background:white;padding:14px;border-radius:10px;box-shadow:0 6px 16px rgba(15,23,42,0.04);}
    .chart-area{flex:1;min-height:220px;}
    .list-area{width:260px;max-height:220px;overflow:auto;padding:6px 8px;border-left:1px solid #eef4ff;}
    .list-item{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px dashed #f1f6ff;font-size:13px;}
    .toast{position:fixed;right:18px;bottom:18px;background:rgba(37,99,235,0.95);color:white;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(15,23,42,0.2);z-index:9999;font-weight:600;display:none;}
    footer{max-width:1100px;margin:22px auto;padding:18px 20px;color:#555;font-size:13px;text-align:center;}
    @media (min-width:900px){.reports-grid{grid-template-columns:1fr 1fr;}}
    @media (min-width:1200px){.reports-grid{grid-template-columns:1fr 1fr 1fr;}}
  </style>
</head>
<body>
<header>
  <div class="header-container">
    <img src="gs.jfif" alt="GSC logo" class="gsc-logo">
    <div class="header-text">
      <h1>Good Samaritan Colleges</h1>
      <p>Faculty Laboratory eLog System</p>
    </div>
  </div>
</header>

<nav>
  <div id="tab-logbook" class="tab active">Logbook</div>
  <div id="tab-reports" class="tab">Reports</div>
</nav>

<main>
<section id="view-logbook">
  <div class="card">
    <form id="elogForm">
      <h2>Add Faculty Log</h2>
      <div class="row">
        <div class="col"><input id="faculty_name" placeholder="Faculty Name" required></div>
        <div class="col"><input id="department" placeholder="Department" required></div>
      </div>
      <div class="row">
        <div class="col"><input id="room_name" placeholder="Laboratory Room Name" required></div>
        <div class="col"><input id="room_number" placeholder="Room Number (optional)"></div>
      </div>
      <input id="equipment" placeholder="Special / Major Equipment Used (optional)">
      <div class="row">
        <div class="col"><input type="date" id="date" readonly></div>
        <div class="col"><input type="time" id="time_in" required></div>
        <div class="col"><input type="time" id="time_out" required></div>
      </div>
      <input id="purpose" placeholder="Purpose / Activity" required>
      <textarea id="remarks" rows="2" placeholder="Remarks (optional)"></textarea>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="primary" type="submit">Add Log</button>
        <button class="secondary" id="clearFormBtn" type="button">Clear</button>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="controls">
      <button id="loadOnlineBtn" class="secondary">Load Online Logs</button>
      <button id="exportCsvBtn" class="secondary">Export File</button>
      <button id="printLogsBtn" class="secondary">Print Logs</button>
    </div>

    <table id="elogTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Faculty Name</th>
          <th>Department</th>
          <th>Room Name</th>
          <th>Room #</th>
          <th>Equipment Used</th>
          <th>Date</th>
          <th>Time In</th>
          <th>Time Out</th>
          <th>Purpose</th>
          <th>Remarks</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="view-reports" style="display:none;">
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;color:var(--gsc-blue)">Faculty Laboratory Usage Report — Good Samaritan Colleges</h2>
      <div style="margin-top:6px;color:#444">Generated: <span id="reportDatePretty"></span></div>
    </div>
    <div><button id="printReportsBtn" class="primary">Print Reports</button></div>
  </div>

  <div class="reports-grid">
    <div class="report-card">
      <div class="chart-area"><canvas id="chartRooms"></canvas></div>
      <div class="list-area"><strong>Rooms (counts)</strong><div id="listRooms"></div></div>
    </div>
    <div class="report-card">
      <div class="chart-area"><canvas id="chartEquipment"></canvas></div>
      <div class="list-area"><strong>Equipment (counts)</strong><div id="listEquipment"></div></div>
    </div>
    <div class="report-card">
      <div class="chart-area"><canvas id="chartFaculty"></canvas></div>
      <div class="list-area"><strong>Faculty (counts)</strong><div id="listFaculty"></div></div>
    </div>
  </div>
</section>
</main>

<footer>
  © 2025 Good Samaritan Colleges | Faculty Laboratory eLog System<br>
  Developed by Piolo L. Bernardino – Laboratory Custodian
</footer>

<div id="toast" class="toast"></div>

<script>
/* ---- Config ---- */
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1BFmqX4hjDp73GpYzFZFTwx22l-l5WtbU4UPh2ncr4hs/gviz/tq?tqx=out:csv";

/* ---- Base logic ---- */
const form=document.getElementById('elogForm');
const tableBody=document.querySelector('#elogTable tbody');
const tabLog=document.getElementById('tab-logbook'),tabReports=document.getElementById('tab-reports');
const viewLog=document.getElementById('view-logbook'),viewReports=document.getElementById('view-reports');
const toastEl=document.getElementById('toast');
let logs=JSON.parse(localStorage.getItem('facultyLogs'))||[];

function showToast(msg,d=2500){toastEl.textContent=msg;toastEl.style.display='block';setTimeout(()=>toastEl.style.display='none',d);}
function makeId(){return Date.now()+Math.floor(Math.random()*1000);}
function escapeHtml(s){return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):'';}
function setDateTimeNowToForm(){const n=new Date();document.getElementById('date').value=n.toISOString().split('T')[0];document.getElementById('time_in').value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}

function renderTable(){
  tableBody.innerHTML='';
  logs.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(i.created_at).toLocaleString()}</td><td>${escapeHtml(i.faculty_name)}</td><td>${escapeHtml(i.department)}</td>
    <td>${escapeHtml(i.room_name)}</td><td>${escapeHtml(i.room_number)}</td><td>${escapeHtml(i.equipment)}</td>
    <td>${escapeHtml(i.date)}</td><td>${escapeHtml(i.time_in)}</td><td>${escapeHtml(i.time_out)}</td>
    <td>${escapeHtml(i.purpose)}</td><td>${escapeHtml(i.remarks)}</td>
    <td><button class="secondary" onclick="deleteLog('${i._id}')">Delete</button></td>`;
    tableBody.appendChild(tr);
  });
  localStorage.setItem('facultyLogs',JSON.stringify(logs));
  updateReports();
}

form.addEventListener('submit',e=>{
  e.preventDefault();
  const n=Date.now();
  const it={_id:makeId(),created_at:n,faculty_name:faculty_name.value,department:department.value,room_name:room_name.value,room_number:room_number.value,equipment:equipment.value,date:date.value,time_in:time_in.value,time_out:time_out.value,purpose:purpose.value,remarks:remarks.value};
  logs.push(it);renderTable();form.reset();setDateTimeNowToForm();showToast('✅ Log saved locally');});

window.deleteLog=id=>{if(!confirm('Delete this entry?'))return;logs=logs.filter(x=>x._id!==id);renderTable();};

document.getElementById('exportCsvBtn').addEventListener('click',()=>{
  if(!logs.length){showToast('⚠️ No logs to export');return;}
  const headers=['Timestamp','Faculty Name','Department','Room Name','Room #','Equipment Used','Date','Time In','Time Out','Purpose','Remarks'];
  const rows=logs.map(r=>[new Date(r.created_at).toLocaleString(),r.faculty_name,r.department,r.room_name,r.room_number,r.equipment,r.date,r.time_in,r.time_out,r.purpose,r.remarks]);
  const csv=[headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`faculty_elog_${new Date().toISOString().slice(0,10)}.csv`;a.click();URL.revokeObjectURL(url);
  showToast('✅ Exported as CSV');
});

document.getElementById('printLogsBtn').addEventListener('click',()=>window.print());
document.getElementById('clearFormBtn').addEventListener('click',()=>{form.reset();setDateTimeNowToForm();});
tabLog.addEventListener('click',()=>{tabLog.classList.add('active');tabReports.classList.remove('active');viewLog.style.display='';viewReports.style.display='none';});
tabReports.addEventListener('click',()=>{tabReports.classList.add('active');tabLog.classList.remove('active');viewReports.style.display='';viewLog.style.display='none';updateReports();});

function computeCounts(){const r={},e={},f={};logs.forEach(l=>{r[l.room_name||'(No room)']=(r[l.room_name]||0)+1;e[l.equipment||'(No equipment)']=(e[l.equipment]||0)+1;f[l.faculty_name||'(No name)']=(f[l.faculty_name]||0)+1;});return{r,e,f};}
function populateList(c,o){c.innerHTML='';const i=Object.entries(o).sort((a,b)=>b[1]-a[1]);if(!i.length){c.innerHTML='<div>No entries</div>';return;}i.forEach(([k,v])=>{const d=document.createElement('div');d.className='list-item';d.innerHTML=`<div>${k}</div><div>${v}</div>`;c.appendChild(d);});}
let chartRooms,chartEquipment,chartFaculty;
function updateChart(id,obj,inst){const l=Object.keys(obj),d=Object.values(obj),ctx=document.getElementById(id).getContext('2d');if(inst){inst.data.labels=l;inst.data.datasets[0].data=d;inst.update();return inst;}
return new Chart(ctx,{type:'bar',data:{labels:l,datasets:[{data:d,backgroundColor:l.map(()=> 'rgba(37,99,235,0.75)')}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});}
function updateReports(){reportDatePretty.textContent=new Date().toLocaleString();const c=computeCounts();populateList(listRooms,c.r);populateList(listEquipment,c.e);populateList(listFaculty,c.f);
chartRooms=updateChart('chartRooms',c.r,chartRooms);chartEquipment=updateChart('chartEquipment',c.e,chartEquipment);chartFaculty=updateChart('chartFaculty',c.f,chartFaculty);}

/* ---- LIVE GOOGLE SHEETS FETCH ---- */
async function fetchFromSheet(){
  try{
    const res=await fetch(GOOGLE_SHEET_CSV_URL);
    const csvText=await res.text();
    const rows=csvText.trim().split('\n').map(r=>r.split(','));
    const headers=rows.shift();
    const newLogs=rows.map(r=>{const o={};headers.forEach((h,i)=>o[h.trim()]=(r[i]||'').trim());return o;});
    logs=newLogs.map((row,i)=>({_id:i+1,created_at:row["Timestamp"]||new Date().toISOString(),faculty_name:row["Faculty Name"]||"",department:row["Department"]||"",room_name:row["Room Name"]||"",room_number:row["Room #"]||"",equipment:row["Equipment Used"]||"",date:row["Date"]||"",time_in:row["Time In"]||"",time_out:row["Time Out"]||"",purpose:row["Purpose"]||"",remarks:row["Remarks"]||""}));
    renderTable();showToast('✅ Live data loaded from Google Sheets');
  }catch(err){console.error('Fetch error',err);showToast('⚠️ Failed to fetch live data');}
}

document.getElementById('loadOnlineBtn').addEventListener('click',fetchFromSheet);

/* ---- Init ---- */
setDateTimeNowToForm();renderTable();fetchFromSheet();
</script>
</body>
</html>
