<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faculty Laboratory E-Log | Good Samaritan Colleges</title>
<link rel="icon" href="gs.jfif">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {font-family: Arial, sans-serif; margin: 0; background: #f8f9fc;}
  header {background: #2563eb; color: white; padding: 15px; text-align: center;}
  header h1 {margin: 0; font-size: 1.5rem;}
  nav {display: flex; justify-content: center; background: #e2e8f0;}
  nav button {padding: 10px 20px; border: none; background: none; font-size: 1rem; cursor: pointer;}
  nav button.active {background: #2563eb; color: white; border-radius: 5px;}
  section {padding: 20px;}
  form {max-width: 800px; margin: auto; display: grid; gap: 10px;}
  label {font-weight: bold;}
  input, select, textarea {padding: 8px; border: 1px solid #ccc; border-radius: 5px;}
  button.primary {background: #2563eb; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;}
  button.secondary {background: #e11d48; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;}
  .table-container {overflow-x: auto; margin-top: 20px;}
  table {width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;}
  th, td {border: 1px solid #ccc; padding: 8px; text-align: left; white-space: nowrap;}
  th {background: #2563eb; color: white;}
  tr:nth-child(even){background: #f1f5f9;}
  .toast {display: none; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: #2563eb; color: white; padding: 10px 20px; border-radius: 20px;}
  .report-container {max-width: 900px; margin: auto;}
  .report-section {margin-bottom: 20px;}
  .list-item {display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #ddd;}
  footer {text-align: center; font-size: 0.85rem; color: gray; margin-top: 30px;}
  @media print {
    nav, form, .toast, #exportCsvBtn, #printLogsBtn {display: none;}
    header {background: none; color: black; text-align: center;}
    body {background: white;}
    footer {position: fixed; bottom: 0; left: 0; right: 0; text-align: center;}
  }
</style>
</head>
<body>
  <header>
    <h1>Faculty Laboratory E-Log — Good Samaritan Colleges</h1>
  </header>

  <nav>
    <button id="tab-logbook" class="active">Logbook</button>
    <button id="tab-reports">Reports</button>
  </nav>

  <!-- Logbook -->
  <section id="view-logbook">
    <form id="elogForm">
      <label>Faculty Name</label>
      <input type="text" id="faculty_name" required>
      <label>Department</label>
      <input type="text" id="department" required>
      <label>Room Name</label>
      <input type="text" id="room_name" required>
      <label>Room Number</label>
      <input type="text" id="room_number" required>
      <label>Equipment Used</label>
      <input type="text" id="equipment">
      <label>Date</label>
      <input type="date" id="date" required>
      <label>Time In</label>
      <input type="time" id="time_in" required>
      <label>Time Out</label>
      <input type="time" id="time_out" required>
      <label>Purpose</label>
      <textarea id="purpose" required></textarea>
      <label>Remarks</label>
      <textarea id="remarks"></textarea>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:10px;">
        <button type="submit" class="primary">Submit Log</button>
        <button type="button" id="clearFormBtn" class="secondary">Clear</button>
      </div>
    </form>

    <div class="table-container">
      <table id="elogTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Faculty Name</th>
            <th>Department</th>
            <th>Room Name</th>
            <th>Room #</th>
            <th>Equipment</th>
            <th>Date</th>
            <th>Time In</th>
            <th>Time Out</th>
            <th>Purpose</th>
            <th>Remarks</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="text-align:center;margin-top:15px;">
      <button id="exportCsvBtn" class="primary">Export CSV</button>
      <button id="printLogsBtn" class="primary">Print Logs</button>
    </div>
  </section>

  <!-- Reports -->
  <section id="view-reports" style="display:none;">
    <div class="report-container">
      <h2 style="text-align:center;">Faculty Laboratory Usage Report</h2>
      <p style="text-align:center;">Generated: <span id="reportDatePretty"></span></p>
      <div class="report-section">
        <h3>Most Used Rooms</h3>
        <canvas id="chartRooms" height="150"></canvas>
        <div id="listRooms"></div>
      </div>
      <div class="report-section">
        <h3>Most Used Equipment</h3>
        <canvas id="chartEquipment" height="150"></canvas>
        <div id="listEquipment"></div>
      </div>
      <div class="report-section">
        <h3>Most Active Faculty</h3>
        <canvas id="chartFaculty" height="150"></canvas>
        <div id="listFaculty"></div>
      </div>
      <div style="text-align:center;margin-top:20px;">
        <button id="printReportsBtn" class="primary">Print Report</button>
      </div>
    </div>
  </section>

  <footer>© 2025 Good Samaritan Colleges — Prepared by: Piolo L. Bernardino, Laboratory Custodian</footer>
  <div id="toast" class="toast"></div>

<script>
/* ----- Google Form Integration (your form link) ----- */
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSdPZLGabjI36s4iFdU-grRUK0ouLvoYrkV391MLxPrRWdZiHQ/formResponse";
const FORM_ENTRY = {
  faculty_name: "entry.162082453",
  department: "entry.694323400",
  room_name: "entry.1656788187",
  room_number: "entry.1132289973",
  equipment: "entry.19898501",
  date: "entry.1998901142",
  time_in: "entry.736543893",
  time_out: "entry.1466121044",
  purpose: "entry.589165766",
  remarks: "entry.1595227859"
};
/* ----------------------------------------------------- */

const form = document.getElementById('elogForm');
const tableBody = document.querySelector('#elogTable tbody');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const printLogsBtn = document.getElementById('printLogsBtn');
const printReportsBtn = document.getElementById('printReportsBtn');
const toastEl = document.getElementById('toast');
const tabLog = document.getElementById('tab-logbook');
const tabReports = document.getElementById('tab-reports');
const viewLog = document.getElementById('view-logbook');
const viewReports = document.getElementById('view-reports');

let logs = JSON.parse(localStorage.getItem('facultyLogs')) || [];
function makeId(){ return Date.now() + Math.floor(Math.random()*1000); }

function showToast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none',2000); }

function renderTable(){
  tableBody.innerHTML = '';
  logs.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(item.created_at).toLocaleString()}</td>
      <td>${item.faculty_name}</td>
      <td>${item.department}</td>
      <td>${item.room_name}</td>
      <td>${item.room_number}</td>
      <td>${item.equipment}</td>
      <td>${item.date}</td>
      <td>${item.time_in}</td>
      <td>${item.time_out}</td>
      <td>${item.purpose}</td>
      <td>${item.remarks}</td>
      <td><button class="secondary" onclick="deleteLog('${item._id}')">Delete</button></td>`;
    tableBody.appendChild(tr);
  });
  localStorage.setItem('facultyLogs', JSON.stringify(logs));
  updateReports();
}

async function uploadToGoogleForm(data){
  try{
    const fd = new FormData();
    for(const k in FORM_ENTRY){ fd.append(FORM_ENTRY[k], data[k]||''); }
    await fetch(GOOGLE_FORM_ACTION, {method:'POST', mode:'no-cors', body: fd});
    showToast('✅ Synced to Google Sheets');
  }catch{ showToast('⚠️ Saved locally (Form offline)'); }
}

form.addEventListener('submit', e=>{
  e.preventDefault();
  const obj={
    _id:makeId(),
    created_at:Date.now(),
    faculty_name:faculty_name.value.trim(),
    department:department.value.trim(),
    room_name:room_name.value.trim(),
    room_number:room_number.value.trim(),
    equipment:equipment.value.trim(),
    date:date.value,
    time_in:time_in.value,
    time_out:time_out.value,
    purpose:purpose.value.trim(),
    remarks:remarks.value.trim()
  };
  logs.push(obj); renderTable();
  uploadToGoogleForm(obj);
  form.reset();
});

window.deleteLog = id=>{
  if(confirm('Delete this entry?')){
    logs = logs.filter(x=>x._id!==id);
    renderTable();
  }
};

exportCsvBtn.onclick = ()=>{
  if(!logs.length) return showToast('⚠️ No logs to export');
  const headers=['Timestamp','Faculty Name','Department','Room Name','Room #','Equipment','Date','Time In','Time Out','Purpose','Remarks'];
  const rows=logs.map(x=>[new Date(x.created_at).toLocaleString(),x.faculty_name,x.department,x.room_name,x.room_number,x.equipment,x.date,x.time_in,x.time_out,x.purpose,x.remarks]);
  const csv=[headers,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='faculty_elog.csv'; a.click();
  URL.revokeObjectURL(url);
};

printLogsBtn.onclick=()=>window.print();
printReportsBtn.onclick=()=>{ tabReports.click(); setTimeout(()=>window.print(),500); };

tabLog.onclick=()=>{tabLog.classList.add('active');tabReports.classList.remove('active');viewLog.style.display='';viewReports.style.display='none';};
tabReports.onclick=()=>{tabReports.classList.add('active');tabLog.classList.remove('active');viewReports.style.display='';viewLog.style.display='none';updateReports();};

function computeCounts(){
  const rooms={},equip={},faculty={};
  logs.forEach(l=>{
    rooms[l.room_name]=(rooms[l.room_name]||0)+1;
    equip[l.equipment]=(equip[l.equipment]||0)+1;
    faculty[l.faculty_name]=(faculty[l.faculty_name]||0)+1;
  });
  return{rooms,equip,faculty};
}

function populateList(container,obj){
  container.innerHTML='';
  const arr=Object.entries(obj).sort((a,b)=>b[1]-a[1]);
  if(!arr.length){container.innerHTML='<div style="color:#666;">No entries</div>';return;}
  arr.forEach(([k,v])=>{const d=document.createElement('div');d.className='list-item';d.innerHTML=`<div>${k}</div><div>${v}</div>`;container.appendChild(d);});
}

let chartRooms,chartEquipment,chartFaculty;
function updateChart(id,obj,inst){
  const labels=Object.keys(obj),data=Object.values(obj),ctx=document.getElementById(id).getContext('2d');
  if(inst){inst.data.labels=labels;inst.data.datasets[0].data=data;inst.update();return inst;}
  return new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'rgba(37,99,235,0.7)'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

function updateReports(){
  document.getElementById('reportDatePretty').textContent=new Date().toLocaleString();
  const c=computeCounts();
  populateList(listRooms,c.rooms);
  populateList(listEquipment,c.equip);
  populateList(listFaculty,c.faculty);
  chartRooms=updateChart('chartRooms',c.rooms,chartRooms);
  chartEquipment=updateChart('chartEquipment',c.equip,chartEquipment);
  chartFaculty=updateChart('chartFaculty',c.faculty,chartFaculty);
}

renderTable();
</script>
</body>
</html>
