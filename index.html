<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Laboratory Usage System</title>
<link rel="icon" type="image/png" href="gs.jfif">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{--gsc-blue:#0f172a;--gsc-accent:#2563eb;--gsc-bg:#f8fafc;--muted:#64748b}
  *{box-sizing:border-box}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:0;background:var(--gsc-bg);color:var(--gsc-blue)}
  header{background:white;padding:14px 20px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
  .header-container{display:flex;align-items:center;gap:14px;max-width:1200px;margin:0 auto}
  .gsc-logo{width:72px;border-radius:8px}
  nav{max-width:1200px;margin:12px auto;padding:0 20px;display:flex;gap:10px}
  .tab{background:white;padding:9px 14px;border-radius:10px;border:1px solid #eef2ff;cursor:pointer;font-weight:700}
  .tab.active{background:linear-gradient(90deg,var(--gsc-accent),#1e40af);color:white}
  main{max-width:1200px;margin:18px auto;padding:0 20px 40px}
  .card{background:white;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(15,23,42,.04);margin-bottom:18px}
  label{font-weight:700;font-size:13px;display:block;margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px;border:1px solid #e6eefc;border-radius:8px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row .col{flex:1;min-width:160px}
  button.primary{background:var(--gsc-accent);color:white;border:none;padding:10px 12px;border-radius:8px;font-weight:800}
  button.secondary{background:white;border:1px solid #e6eefc;padding:9px 12px;border-radius:8px}
  .controls{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(37,99,235,.95);color:white;padding:10px 14px;border-radius:8px;z-index:9999;display:none}
  @media print { nav, .controls, form, footer, .toast { display:none !important; } }
</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="gs.jfif" class="gsc-logo">
    <div>
      <h2>Good Samaritan Colleges</h2>
      <p>Laboratory Usage System</p>
    </div>
  </div>
</header>

<nav>
  <div id="tab-logbook" class="tab active">Logbook</div>
  <div id="tab-reports" class="tab">Reports</div>
</nav>

<main>

<!-- LOGBOOK -->
<section id="view-logbook">
  <div class="card">
    <form id="elogForm">
      <h2>Quick Log</h2>

      <div class="row">
        <div class="col"><label>Faculty Name</label><input id="faculty_name" required></div>
        <div class="col"><label>Department</label><input id="department" required></div>
        <div class="col"><label>Room</label><input id="room_name" required></div>
      </div>

      <div class="row">
        <div class="col"><label>Room #</label><input id="room_number"></div>
        <div class="col"><label>Equipment</label><input id="equipment"></div>
        <div class="col"><label>Date</label><input type="date" id="date" required></div>
      </div>

      <div class="row">
        <div class="col"><label>Time In</label><input type="time" id="time_in" required></div>
        <div class="col"><label>Time Out</label><input type="time" id="time_out" required></div>
        <div class="col"><label>Purpose</label><input id="purpose" required></div>
      </div>

      <label>Remarks</label>
      <textarea id="remarks" rows="2"></textarea>

      <!-- Removed QR + Signature buttons -->
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px">
        <button class="primary" type="submit">Add Log</button>
      </div>

    </form>
  </div>

  <div class="card">
    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="searchInput" class="search-input" placeholder="Search..." />
        <select id="filterDept"><option value="">All Departments</option></select>
        <input type="date" id="filterDateStart"/>
        <input type="date" id="filterDateEnd"/>
        <button id="clearFilters" class="secondary">Clear</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="exportCsvBtn" class="secondary">Export CSV</button>
        <button id="printLogsBtn" class="secondary">Print</button>
        <button id="loadSheetBtn" class="secondary">Load Live Sheet</button>
      </div>
    </div>

    <table id="elogTable" style="width:100%">
      <thead>
        <tr>
          <th>Timestamp</th><th>Faculty</th><th>Dept</th><th>Room</th><th>Room #</th>
          <th>Equip</th><th>Date</th><th>In</th><th>Out</th><th>Purpose</th>
          <th>Remarks</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>
</section>

<!-- REPORTS -->
<section id="view-reports" style="display:none;">
  <div class="card">
    <h2>Usage Reports</h2>
    <p>Generated: <span id="reportDatePretty"></span></p>
    <button id="printReportsBtn" class="primary">Print Reports</button>
  </div>

  <div class="card"><canvas id="chartRooms"></canvas></div>
  <div class="card"><canvas id="chartEquipment"></canvas></div>
  <div class="card"><canvas id="chartFaculty"></canvas></div>
</section>

</main>

<footer>
  © 2025 Good Samaritan Colleges — Faculty Laboratory eLog System<br>
  Prepared by Piolo L. Bernardino
</footer>

<div id="toast" class="toast"></div>

<script>
// ----------------------------------------
// FIXED: Declare all input elements
// ----------------------------------------
const faculty_name = document.getElementById('faculty_name');
const department = document.getElementById('department');
const room_name = document.getElementById('room_name');
const room_number = document.getElementById('room_number');
const equipment = document.getElementById('equipment');
const date = document.getElementById('date');
const time_in = document.getElementById('time_in');
const time_out = document.getElementById('time_out');
const purpose = document.getElementById('purpose');
const remarks = document.getElementById('remarks');

// ----------------------------------------
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSdPZLGabjI36s4iFdU-grRUK0ouLvoYrkV391MLxPrRWdZiHQ/formResponse";
const FORM_ENTRY = {
  faculty_name:"entry.694323400",
  department:"entry.1656788187",
  room_name:"entry.1132289973",
  room_number:"entry.19898501",
  equipment:"entry.743283452",
  date:"entry.1998901142",
  time_in:"entry.736543893",
  time_out:"entry.1466121044",
  purpose:"entry.589165766",
  remarks:"entry.1595227859"
};

const SHEET_ID = "1BFmqX4hjDp73GpYzFZFTwx22l-l5WtbU4UPh2ncr4hs";
const SHEET_NAME = "Form Responses 1";

const form = document.getElementById('elogForm');
const tableBody = document.querySelector('#elogTable tbody');

let logs = JSON.parse(localStorage.getItem('facultyLogs_v2')) || [];
let unsynced = JSON.parse(localStorage.getItem('unsyncedLogs_v2')) || [];

function makeId(){return Date.now()+Math.floor(Math.random()*1000);}
function showToast(msg){
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.display = 'block';
  setTimeout(()=>t.style.display='none',2000);
}

// ----------------------------------------
// Submit form
// ----------------------------------------
form.addEventListener('submit', e=>{
  e.preventDefault();

  if(time_out.value < time_in.value){
    return showToast("Time-out cannot be earlier than Time-in");
  }

  const item = {
    _id: makeId(),
    created_at: Date.now(),
    faculty_name: faculty_name.value,
    department: department.value,
    room_name: room_name.value,
    room_number: room_number.value,
    equipment: equipment.value,
    date: date.value,
    time_in: time_in.value,
    time_out: time_out.value,
    purpose: purpose.value,
    remarks: remarks.value
  };

  logs.push(item);
  localStorage.setItem('facultyLogs_v2',JSON.stringify(logs));

  renderTable();
  form.reset();
  showToast("Log added ✔");

  enqueueSync(item);
});

// ----------------------------------------
async function enqueueSync(item){
  unsynced.push(item);
  localStorage.setItem('unsyncedLogs_v2',JSON.stringify(unsynced));

  try{
    await uploadToGoogleForm(item);
    unsynced = unsynced.filter(x=>x._id!==item._id);
    localStorage.setItem('unsyncedLogs_v2',JSON.stringify(unsynced));
  } catch(e){
    showToast("Saved locally (offline)");
  }
}

async function uploadToGoogleForm(obj){
  const fd = new FormData();
  for(const k in FORM_ENTRY){
    fd.append(FORM_ENTRY[k], obj[k] || "");
  }
  return fetch(GOOGLE_FORM_ACTION,{method:"POST",mode:"no-cors",body:fd});
}

// ----------------------------------------
function renderTable(){
  tableBody.innerHTML = '';
  logs.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(item.created_at).toLocaleString()}</td>
      <td>${item.faculty_name}</td>
      <td>${item.department}</td>
      <td>${item.room_name}</td>
      <td>${item.room_number}</td>
      <td>${item.equipment}</td>
      <td>${item.date}</td>
      <td>${item.time_in}</td>
      <td>${item.time_out}</td>
      <td>${item.purpose}</td>
      <td>${item.remarks}</td>
      <td>
        <button onclick="editLog(${item._id})" class="secondary">Edit</button>
        <button onclick="deleteLog(${item._id})" class="secondary">Delete</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

// ----------------------------------------
window.deleteLog = id=>{
  logs = logs.filter(x=>x._id!=id);
  localStorage.setItem('facultyLogs_v2',JSON.stringify(logs));
  renderTable();
  showToast("Entry deleted");
}

window.editLog = id=>{
  const item = logs.find(x=>x._id==id);
  if(!item) return;

  const newName = prompt("Faculty name:", item.faculty_name);
  if(newName!==null) item.faculty_name = newName;

  const newDept = prompt("Department:", item.department);
  if(newDept!==null) item.department = newDept;

  localStorage.setItem('facultyLogs_v2',JSON.stringify(logs));
  renderTable();
  showToast("Entry updated");
}

// ----------------------------------------
document.getElementById('searchInput').addEventListener('input',renderTable);

// ----------------------------------------
renderTable();
</script>

</body>
</html>
